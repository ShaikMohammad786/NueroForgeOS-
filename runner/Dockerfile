# ===============================================
# üß† NeuroForge Runner ‚Äî Multi-language Sandbox
# ===============================================

# Base Image (Python + Debian Slim)
FROM python:3.10-slim

# Set working directory
WORKDIR /app

# ---------------------------------------------------
# 1Ô∏è‚É£ Install system dependencies & language toolchains
# ---------------------------------------------------
# - gcc, g++ for C/C++
# - openjdk-21-jdk for Java
# - nodejs, npm for JavaScript
# - curl for healthcheck/debug utilities
# ---------------------------------------------------
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        gcc g++ openjdk-21-jdk nodejs npm curl bash && \
    rm -rf /var/lib/apt/lists/*

# ---------------------------------------------------
# 2Ô∏è‚É£ Ensure pip is up-to-date and stable
# ---------------------------------------------------
RUN pip install --upgrade pip setuptools wheel

# ---------------------------------------------------
# 3Ô∏è‚É£ Copy requirements and install dependencies
# ---------------------------------------------------
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# ---------------------------------------------------
# 4Ô∏è‚É£ Copy the runner source code
# ---------------------------------------------------
COPY . .

# ---------------------------------------------------
# 5Ô∏è‚É£ Verify Uvicorn installation (failsafe)
# ---------------------------------------------------
RUN python -m pip show uvicorn >/dev/null 2>&1 || \
    (echo "‚ö†Ô∏è Uvicorn missing, installing manually..." && pip install uvicorn)

# ---------------------------------------------------
# 6Ô∏è‚É£ Create non-root user for safety
# ---------------------------------------------------
RUN useradd -m runneruser
USER runneruser

# ---------------------------------------------------
# 7Ô∏è‚É£ Expose Runner port
# ---------------------------------------------------
EXPOSE 8001

# ---------------------------------------------------
# 8Ô∏è‚É£ Define entrypoint (FastAPI Runner Server)
# ---------------------------------------------------
CMD ["python", "-m", "uvicorn", "app:app", "--host", "0.0.0.0", "--port", "8001"]
